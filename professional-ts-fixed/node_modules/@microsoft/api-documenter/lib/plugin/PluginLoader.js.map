{"version":3,"file":"PluginLoader.js","sourceRoot":"","sources":["../../src/plugin/PluginLoader.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport * as path from 'path';\r\nimport * as resolve from 'resolve';\r\n\r\nimport { IApiDocumenterPluginManifest, IFeatureDefinition } from './IApiDocumenterPluginManifest';\r\nimport { MarkdownDocumenterFeature, MarkdownDocumenterFeatureContext } from './MarkdownDocumenterFeature';\r\nimport { PluginFeatureInitialization } from './PluginFeature';\r\nimport { DocumenterConfig } from '../documenters/DocumenterConfig';\r\n\r\ninterface ILoadedPlugin {\r\n  packageName: string;\r\n  manifest: IApiDocumenterPluginManifest;\r\n}\r\n\r\nexport class PluginLoader {\r\n  public markdownDocumenterFeature: MarkdownDocumenterFeature | undefined;\r\n\r\n  public load(\r\n    documenterConfig: DocumenterConfig,\r\n    createContext: () => MarkdownDocumenterFeatureContext\r\n  ): void {\r\n    const configFileFolder: string = path.dirname(documenterConfig.configFilePath);\r\n    for (const configPlugin of documenterConfig.configFile.plugins || []) {\r\n      try {\r\n        // Look for the package name in the same place as the config file\r\n        const resolvedEntryPointPath: string = resolve.sync(configPlugin.packageName, {\r\n          basedir: configFileFolder\r\n        });\r\n\r\n        // Load the package\r\n        const entryPoint:\r\n          | { apiDocumenterPluginManifest?: IApiDocumenterPluginManifest }\r\n          | undefined = require(resolvedEntryPointPath);\r\n\r\n        if (!entryPoint) {\r\n          throw new Error('Invalid entry point');\r\n        }\r\n\r\n        if (!entryPoint.apiDocumenterPluginManifest) {\r\n          throw new Error(\r\n            `The package is not an API documenter plugin;` +\r\n              ` the \"apiDocumenterPluginManifest\" export was not found`\r\n          );\r\n        }\r\n\r\n        const manifest: IApiDocumenterPluginManifest = entryPoint.apiDocumenterPluginManifest;\r\n\r\n        if (manifest.manifestVersion !== 1000) {\r\n          throw new Error(\r\n            `The plugin is not compatible with this version of API Documenter;` +\r\n              ` unsupported manifestVersion`\r\n          );\r\n        }\r\n\r\n        const loadedPlugin: ILoadedPlugin = {\r\n          packageName: configPlugin.packageName,\r\n          manifest\r\n        };\r\n\r\n        const featureDefinitionsByName: Map<string, IFeatureDefinition> = new Map<\r\n          string,\r\n          IFeatureDefinition\r\n        >();\r\n        for (const featureDefinition of manifest.features) {\r\n          featureDefinitionsByName.set(featureDefinition.featureName, featureDefinition);\r\n        }\r\n\r\n        for (const featureName of configPlugin.enabledFeatureNames) {\r\n          const featureDefinition: IFeatureDefinition | undefined = featureDefinitionsByName.get(featureName);\r\n          if (!featureDefinition) {\r\n            throw new Error(\r\n              `The plugin ${loadedPlugin.packageName} does not have a feature with name \"${featureName}\"`\r\n            );\r\n          }\r\n\r\n          if (featureDefinition.kind === 'MarkdownDocumenterFeature') {\r\n            if (this.markdownDocumenterFeature) {\r\n              throw new Error('A MarkdownDocumenterFeature is already loaded');\r\n            }\r\n\r\n            const initialization: PluginFeatureInitialization = new PluginFeatureInitialization();\r\n            initialization._context = createContext();\r\n\r\n            let markdownDocumenterFeature: MarkdownDocumenterFeature | undefined = undefined;\r\n            try {\r\n              markdownDocumenterFeature = new featureDefinition.subclass(initialization);\r\n            } catch (e) {\r\n              throw new Error(`Failed to construct feature subclass:\\n` + e.toString());\r\n            }\r\n            if (!(markdownDocumenterFeature instanceof MarkdownDocumenterFeature)) {\r\n              throw new Error('The constructed subclass was not an instance of MarkdownDocumenterFeature');\r\n            }\r\n\r\n            try {\r\n              markdownDocumenterFeature.onInitialized();\r\n            } catch (e) {\r\n              throw new Error('Error occurred during the onInitialized() event: ' + e.toString());\r\n            }\r\n\r\n            this.markdownDocumenterFeature = markdownDocumenterFeature;\r\n          } else {\r\n            throw new Error(`Unknown feature definition kind: \"${featureDefinition.kind}\"`);\r\n          }\r\n        }\r\n      } catch (e) {\r\n        throw new Error(`Error loading plugin ${configPlugin.packageName}: ` + e.message);\r\n      }\r\n    }\r\n  }\r\n}\r\n"]}